stages:
  - test
  - deploy

variables:
  SSH_HOST: "192.168.56.11"
  DEPLOY_DIR: "/home/vagrant/unit-testing-fizzbuzz"

test_job:
  stage: test
  image: node:14
  before_script:
    - apt-get update && apt-get install -y build-essential
    - npm install
  script:
    - npm install jest @babel/core @babel/preset-env babel-jest --save-dev
    - npm run test:coverage
  artifacts:
    paths:
      - coverage/
    expire_in: 1 week

deploy_job:
  stage: deploy
  image: ubuntu:latest
  before_script:
    - eval $(ssh-agent -s)
    - apt-get -yq update
    - apt-get -yqq install ssh iputils-ping
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -   # Añadir clave privada en formato OPENSSH al agente SSH
    - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts    # Agregar host a known_hosts
    - echo "SSH_HOST es $SSH_HOST"
    - ping -c 4 $SSH_HOST

  script:
    - ssh -o StrictHostKeyChecking=no vagrant@$SSH_HOST "echo 'Conexión exitosa!'"
    - ssh -o StrictHostKeyChecking=no vagrant@$SSH_HOST "mkdir -p $DEPLOY_DIR"
    - scp -o StrictHostKeyChecking=no -r . vagrant@$SSH_HOST:$DEPLOY_DIR


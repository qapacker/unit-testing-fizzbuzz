stages:
  - test
  - deploy

variables:
  NODE_ENV: "test"

test_job:
   stage: test
   image: node:14
   before_script:
     - apt-get update && apt-get install -y build-essential
     - npm install
   script:
     - npm install jest @babel/core @babel/preset-env babel-jest --save-dev
     - npm run test:coverage
   artifacts:
     paths:
       - coverage/
     expire_in: 1 week

deploy_job:
  stage: deploy
  image: ubuntu:latest  
  before_script:
  - eval $(ssh-agent -s)  
  - apt-get -yq update 
  - apt-get -yqq install ssh    
  - chmod 600 -D /dev/null ~/.ssh/id_rsa  
  - echo "$SSH_PRIVATE_KEY" | base64 --decode > ~/.ssh/id_rsa   
  - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts  
  script:
    - ssh ubuntu@$SSH_HOST "echo 'Conectado!'"  
    - ssh ubuntu@$SSH_HOST "mkdir -p $DEPLOY_DIR"  
    - scp -r . ubuntu@$SSH_HOST:$DEPLOY_DIR  
    - ssh ubuntu@$SSH_HOST "cd $DEPLOY_DIR && docker-compose up -d --build"  
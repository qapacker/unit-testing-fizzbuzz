# Definici贸n de los stages disponibles
stages:
  - test
  - deploy

# Variables de entorno para el entorno de pruebas
variables:
  NODE_ENV: "test"
  SSH_HOST: "192.168.114.232"  # Agrega la IP como variable de entorno

# Definici贸n del job para ejecutar las pruebas y almacenar cobertura
# test_job:
#   stage: test
#   image: node:14
#   before_script:
#     - apt-get update && apt-get install -y build-essential
#     - npm install
#   script:
#     - npm install jest @babel/core @babel/preset-env babel-jest --save-dev
#     - npm run test:coverage
#   artifacts:
#     paths:
#       - coverage/
#     expire_in: 1 week

# Job de despliegue
deploy_job:
  stage: deploy
  image: ubuntu:latest  # Usa la imagen de Docker
  before_script:
  - eval $(ssh-agent -s)  # Inicia el agente SSH
  - apt-get -yq update 
  - apt-get -yqq install ssh  # Instala SSH correctamente
  - mkdir -p ~/.ssh  # Crea el directorio si no existe
  - chmod 700 ~/.ssh  # Asegura que el directorio tenga los permisos correctos
  - echo "$SSH_PRIVATE_KEY" | base64 --decode > ~/.ssh/id_rsa  # Usa la clave SSH directamente
  - chmod 600 ~/.ssh/id_rsa  # Asegura que la clave tenga los permisos correctos
  - ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts  # Agrega el host a `known_hosts`

  script:
    - ssh -v ubuntu@$SSH_HOST "echo 'Conectado!'"  # Verifica la conexi贸n
    - ssh ubuntu@$SSH_HOST "mkdir -p /home/ubuntu/unit-testing-fizzbuzz"  # Crea el directorio en la VM
    - scp -r . ubuntu@$SSH_HOST:/home/ubuntu/unit-testing-fizzbuzz  # Copia el proyecto a la VM
    - ssh ubuntu@$SSH_HOST "cd /home/ubuntu/unit-testing-fizzbuzz && docker-compose up -d --build"  # Levanta la aplicaci贸n usando Docker Compose
